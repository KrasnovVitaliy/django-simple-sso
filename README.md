# Django-simple-sso
Простая реализация SSO для Django. Реализует базовый алгоритм без использования сторонних сервисов.

### Основные термины
**Gateway** - сервис авторизации, хранит базу данных пользователей, предоставляет веб интерфейс для авторизации

**Client** - сервис предоставляющий дополнительную функциональность и требующий аутентификацию на сервисе Gateway

### Workflow
#### Случай 1
![alt text](relative%20img/screen1.png?raw=true "Case 1")
Пользователь заходит в сервис Client без первоначальной авторизации в Gateway.
- Сервис Client делает redirect на сервис Gateway по адресу `/accounts/login` и передает в параметрах `sso_token` - уникальный идентификатор клиента, создается на стороне Gateway и указывается в настройках Client. И параметр `next` - путь по которому надо перейти после авторизации.
- На стороне Gateway после редиректа открывается страница логина, где пользователь вводит логин и пароль.
- Далее проверяются введенные данные и проверяется активный ли пользователь.
- Если все проверки прошли успешно из запроса извлекается `sso_token` по нему ищется соответствующий настроенный клиент.
- Если клиент найден, то создается запись на запрос авторизации `SSOAuthRequest` В ней генерится `auth_token`.
- Затем пользователь перенаправляется обратно на сторону клиента по пути: `/sso/accept/` и передает в параметрах `auth_token` и `next`. Адрес редиректа берется из настроек клиента в Gateway. 
- Client принимает запрос и делает POST запрос на Gateway на путь `/sso/auth` и передает в теле запроса `auth_token` Полученный в предыдущем шаге. 
- Сервер создает запись SSOAuthenticated и отдает JWT токен с данными пользователя. 
- Client может сохраняет JWT токен и использует его для работы

#### Случай 2
![alt text](relative%20img/screen2.png?raw=true "Case 1")
Пользователь заходит в сервис Client раннее авторизовавшись в Gateway.
- Сервис Client делает redirect на сервис Gateway по адресу `/accounts/login` и передает в параметрах `sso_token` - уникальный идентификатор клиента, создается на стороне Gateway и указывается в настройках Client. И параметр `next` - путь по которому надо перейти после авторизации.
- На стороне Gateway после редиректа так как пользователь уже авторизован из запроса извлекается `sso_token` по нему ищется соответствующий настроенный клиент.
- Если клиент найден, то создается запись на запрос авторизации `SSOAuthRequest` В ней генерится `auth_token`.
- Затем пользователь перенаправляется обратно на сторону клиента по пути: `/sso/accept/` и передает в параметрах `auth_token` и `next`. Адрес редиректа берется из настроек клиента в Gateway. 
- Client принимает запрос и делает POST запрос на Gateway на путь `/sso/auth` и передает в теле запроса `auth_token` Полученный в предыдущем шаге. 
- Сервер создает запись SSOAuthenticated и отдает JWT токен с данными пользователя. 
- Client может сохраняет JWT токен и использует его для работы

#### Случай 3
![alt text](relative%20img/screen3.png?raw=true "Case 1")
Пользователь заходит в сервис Gateway и из него переходит в Client.
- Переход на Client осуществляется по ссылке с параметром `auth_token` 
- Client проверяет залогинен ли пользователь.
- Если пользователь не авторизован Client извлекает `auth_token` и отправляет хапрос в Gateway в. path `sso/validate/auth` передавая в теле запроса `auth_token`
- Gateway проверяет наличие SSOAuthenticated записи с полученным `auth_token`
- Если запись найдена в ней обновлается `auth_token` и Client отдается JWT token с данными пользователя. 